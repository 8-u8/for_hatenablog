# この記事は
[R Advent Calendar 2022](https://qiita.com/advent-calendar/2022/rlang)11日目の記事です。
10日目の記事には[しょこさん](url)の記事ですね。Twitterでは個人的に「動くグラフ」をたくさん作っているすごい人、という認識です。

# お久しぶりです
結局月1投稿すらままならなかったですが、元気にやっています。アドカレの記事でいうこともないのですが、以下のご報告をします。
- 結婚しました
- PC買いました
- 統計検定はダメでした
- CTF始めました
- 転職します
- 来年もよろしくお願いします

# 内容
仕事と個人的な道楽を兼ねて一時期勉強していたMarketing Mixed Modelについて、  
そのコンセプトとMeta社の実装であるRobynをWalkthroughしようと思います。

[https://github.com/facebookexperimental/Robyn:embed:cite]

<!--more-->

# 実行環境
以下のgithubにコードはだいたいおいてあります。

[https://github.com/8-u8/for_hatenablog/tree/master/R_Advent_Calendar_2022:embed:cite]

以下の環境で動作をさせています。Rは優しいので、バージョン4.0くらいなら動作すると思います。ただし、WSL2上のUbuntuでは挙動不審でした。  
Robynは`reticulate`パッケージを通して、裏でPythonを使っているのですが、  
僕の環境ではWSL2にconda系を入れたくなくて、`pipenv`の仮想環境を使いたかったことが、あまり良い結果に結びつかなかったのかもしれないです。  
`reticulate`の挙動はよくわからないですが、セッション単位でPythonの仮想環境が作れるようなので、よほどのことがなければ、ドキュメント通りに仮想環境を立てて良いと思います。  
- PC: Thinkpad T14 Gen3
- OS: windows 11
- RAM: 32GiB
- CPU: 12th Gen Intel(R) Core(TM) i7-1260P
- Rのバージョン: 以下。
```r
> version
               _                                
platform       x86_64-w64-mingw32               
arch           x86_64                           
os             mingw32                          
crt            ucrt                             
system         x86_64, mingw32                  
status                                          
major          4                                
minor          2.2                              
year           2022                             
month          10                               
day            31                               
svn rev        83211                            
language       R                                
version.string R version 4.2.2 (2022-10-31 ucrt)
nickname       Innocent and Trusting     
```


# MMMとは
## 先駆者の記述
[saltcockeyさん](https://saltcooky.hatenablog.com/entry/2021/08/25/025232)の記事や[TJOさん](https://tjo.hatenablog.com/entry/2018/09/01/170340)の記事では、
MMMが何を表現しているモデルであるかを所与として、広告効果の時系列上の波及をよく表現するモデルとはなにか、丁寧に記述されています。  
本記事を読む人はMarketing Mixed Modelについてよくわかっている人かも知れないし、そうではないかもしれないので、とりあえずどんなコンセプトのモデルなのか、どういう問題に答えるモデルなのかから記述していきます。  
後述するように、有名なMMMのOSSとして、今回紹介するRobynとGoogleのLightWeight MMMがありますが、モデルが表現する対象や表現方法は同じで、どのように未知パラメータを探索・推定するか、という部分に明確な思想の違いがあります。

※ あくまで個人の見解なので、間違った理解があったらごめんね。

## MMMのコンセプト
Marketing Mixed Model(面倒なのでMMMと略します)は、広告の予算及び広告の反応を用いて、売上金額や来店客数、資料請求など、企業の利益に直結する成果を表現することで「広告が利益にどれだけ効果を与えたか」を説明・評価するモデルです。  
Cockieの廃止など、個人を追いかけにくくなるWeb広告や、そもそも個人を追いかけるのが困難なマスメディアの広告を総合的に評価できるという点で、2022年はホットな話題が多かったかなと個人的には感じています。  
どのように広告の効果で利益指標を表現するかというと、回帰モデルが基本フレームワーク担っています。具体的にはRobynもLightWeight MMMも、以下のような構造が共通しています。

$$利益指標_t = 切片 + トレンド_t + 季節性_t + f(広告予算orコスト_t) + その他要因_t$$

ここで、$t$は時系列に関するインデックス、$f(.)$は広告予算・コストのラグ効果を考慮するための関数を表現しています。この点は後述します。

「その他要因」については、たとえば競合のプロモーションなど、自社の広告以外に利益指標に影響を与えそうな要因を指します。

MMMは、これら各項の影響度を推定することで、広告の利益指標に対する効果を記述・説明します。

パラメータが推定できれば、上記のモデル式を援用することで、広告の投資収益率(ROI)を算出することも可能です。

## 想定入力データ
入力データは関係各所が様々に定式化していますが、基本は以下の変数が時系列で必要です。
- 利益指標(売上、来店客数、資料請求数など)
- 広告インプレッション(メディア別)
- 広告コスト(投下予算・メディア別)
- その他要因に関連する変数
  - 天気や気温
  - 競合のプロモーション
  - ニュース

目的変数となる利益指標と、説明変数である広告インプレッションまたは予算は必須ですが、  
その他要因についてはあってもなくても良いです。スモールスタートを志向するなら、まずはその他要因を考えずにスタートしても良いかもしれません。

## MMMにおけるパラメータ推定
MMMは時系列データを用います。そのため目的変数は自己相関(自己共分散)を持ち、  
普通の回帰モデルが要請する誤差項の独立性が保証されません。  
そのため通常の推定方法では推定値の標準誤差が一致性を持たず、パラメータの仮説検定や信頼区間を正しく計算できません((推定値自体の一致性はあったはず))。  
また、時系列データの特徴をコントロールできても、広告のインプレッションやコストは見かけ上連動しやすく、重回帰モデルにおける多重共線性も懸念されます((たとえば複数メディアで広告を打つことで認知や売上を上げようという戦略は十分考えられると思います))。多重共線性が存在すると、こちらも推定値の標準誤差が大きくなってしまうため、検定や信頼区間に対する信頼性がゆらぎます。  
こうした問題を<s>みなかったこと</s>回避する必要があり、関係各所色々に努力を重ねているところです。  
たとえばLightWeight MMMは階層ベイズモデルを導入してこれらを克服しようとしていますし、後述のようにRobynではRidge回帰によって多重共線性の影響を軽減させています。

## 広告の「ラグ」効果
日常生活を振り返ると、広告を見た「瞬間」に「あ、この商品を買おう」とか「あ、このお店行くか」と思い至ることもあるでしょうが、広告を見て、数日～数週間経た後、日常のお買い物やお散歩などで「この商品テレビでみたわ」とか「あー、あのタレントが出てたCMのお店ここにあったのか」という発見をして、商品を手に取ったり、お店に入ったりすることも大いに考えられます。  
こうした「ラグ」効果をAdstock効果とかCarryover効果とか呼びます。  
Robynでは`geometric`と`weibull`の2つの分布を仮定できます。これらは共通して「当週の広告の効果は、ある減衰率$\theta$によって減衰されつつも次週に繰り越される」という仮定を通して、広告の効果を表現しています。

## MMMの出力
基本的に、MMMは重回帰モデルで表現され、そのパラメータ推定結果から様々な結果指標を評価します。

### 精度
予測値と実測値の乖離がないことが望ましいことはMMMも例外ではありません。Robyn、LightWeight MMM両方とも、予測と実測の乖離度を評価します。  
また、ビジネス課題によっては過剰適合(過学習)も望ましくない場合があるので、  
クロスバリデーションを設計することも有効だと思います((そこまでガチる必要はなくtrain-test splitを行うだけでもいいと思います。でもガチるならちゃんとやった方がいい。))。

### パラメータ推定値
いわゆる「回帰係数」のようなものです。後述の「要因分解」に用います。

### 要因分解
「売上が広告メディアで説明されるとして、どのメディアがどの程度売上を構成しているか？」を表現します。たとえばテレビCMが売上の40%を占めていて、競合のプロモーションが10%程度売上を「押し下げ」ている、というような解釈を通して意思決定が出来ます。  
この要因分解に基づくことで、次の期の広告予算を、どのメディアにどの程度割り当てることで、売上より望めるかというシミュレーション(予算アロケーション)も可能です。

### 反応曲線
広告の予算投資とその反応がどういった関係性を持つのかをモデル化します。
たとえば「Web広告に投下した予算はどれくらい効率的に使われているのか？」に答えます。  
ここでは「一定量の広告投下は必要であるが、投下のし過ぎはむしろ効率が悪い」というような投資効率の変化を表現する事が多いと思います。この仮説を表現するために「S字」の曲線であったり、対数曲線であったりで反応曲線をモデル化し、パラメータを推定します。  
Robynではhill関数、LightWeight MMMではcarryoverモデル、Adstockモデル、hill-Adstockモデルの3つから選べるようになっています。

## つかれた
ここまでMMMのコンセプト部分について記述しました。  
- RobynもLightWeight MMMも基本的には「回帰モデル」を仮定している
- 広告投資効果には「投資効果逓減」を仮定している
- 仮定に基づいて推論し、そこから複数の結果を得ることで、  
総合的に意思決定を行う
    - 場合によっては将来的な広告予算配分のシミュレーションも可能


# Robynとは

# ちなみに: LightWeight MMMやMaMiMo
Robyn以外にMMMを実現するOSSとして、Googleの開発している[LightWeight MMMM](https://github.com/google/lightweight_mmm)があります。   

[https://github.com/google/lightweight_mmm:embed:cite]

GoogleはMMMに対して、いくつか論文として発信しています。
- [Challenges And Opportunities In Media Mix Modeling](https://static.googleusercontent.com/media/research.google.com/ja//pubs/archive/45998.pdf)
- [Bayesian Methods for Media Mix Modeling with Carryover and Shape Effects](https://static.googleusercontent.com/media/research.google.com/ja//pubs/archive/46001.pdf)

LightWeight MMMは基本的にPythonで実装されているので、**R** Advent Calendarであるこの記事では実装しませんが、以下で実装しています。

[https://github.com/8-u8/for_hatenablog/tree/master/python_LMMM_trial:embed:cite]

Rで実装できるMMMは他にもMaMiMoがあります。詳しくは僕もわかっていませんので、近く使ってみようと思っています。

[https://github.com/Garve/mamimo:embed:cite]

## 先駆者記事(in Japanese)
MMMは昨今注目されるモデルなので、いろいろな個人、法人が紹介記事を書いています。  
- saltcockey: [MetaのMMMパッケージ Robynを試してみる](https://saltcooky.hatenablog.com/entry/2022/06/11/225921)
- Crosstab.inc : [マーケターのためのRobynを用いた自動Marketing Mix Modeling (MMM)](https://crosstab.co.jp/%E3%83%9E%E3%83%BC%E3%82%B1%E3%82%BF%E3%83%BC%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AErobyn%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E8%87%AA%E5%8B%95marketing-mix-modeling-mmm/)
- 博報堂DYホールディングス：[マーケティング・サイエンスにおける個票データの課題とMarketing Mix Modeling の「再発見」](https://www.jstage.jst.go.jp/article/pjsai/JSAI2022/0/JSAI2022_2P4GS1002/_pdf)


直近だと博報堂がレビュー論文形式でMMMに言及していて、RobynとLMMMMに関しての比較を(簡単な記述ですが)しています。実装にあたっての思想が違うという点はまさにそう思っていて、個人的にはMMMといえばLMMMの思想が自然に思い浮かばれます。ただし、このアプローチは現実問題との乖離について、合理的な仮定を置いた調整がシビアな印象があり、使うのが難しいように思います。  
その意味でRobynは、モデルとしての完成度、精度、説明可能性の「妥協点」を探すアプローチを取っているという点で、実務に寄り添ったMMMができる、というのは面白いところだなと思います。

また、カスタマイズ性も高いようで、たとえば構造方程式モデリングを援用したモデルの拡張なども可能なようです。

[https://devpost.com/software/test-iyn35s:embed:cite]

# RobynによるMMMの実装

## データ
kaggleにMMMをしやすそうなデータセットがあったので、こちらを援用します。
[https://www.kaggle.com/datasets/saicharansirangi/adanalyse:embed:cite]

日次時系列で、どこでどんな広告をどの程度のコストで打って、売上、インプレッションなどがどれだけ得られたのか、というデータが一通り揃っています。  
今回はRobynでMMMを行う上で必要なデータに絞ってシンプルに実行するために
- 売上(`Sales`)
- 広告インプレッション(`Impressions`) 
- 投資量(`Spend`)

に絞って議論します。

参考:[How To Create A Marketing Mix Model With LightweightMMM](https://forecastegy.com/posts/how-to-create-a-marketing-mix-model-with-lightweightmmm/)



#