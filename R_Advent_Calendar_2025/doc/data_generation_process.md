# データ生成過程と推定方法の理論的整理

## 1. データ生成過程（Data Generating Process: DGP）

### 1.1 モデルの定式化

本研究で使用するデータ生成過程は、以下の構造を持つ：

$$
y_t = \mu_t \cdot (1-\rho) + \rho \cdot y_{t-1} + \varepsilon_t
$$

ここで、

- **決定論的成分** $\mu_t$：
  $$
  \mu_t = \beta_0 + \beta_1 t + \beta_2 I_t + \beta_3 (t-t_0)I_t
  $$
  - $\beta_0$：ベースライン（切片）
  - $\beta_1$：トレンド（時間の線形効果）
  - $\beta_2$：介入による水準変化（Level Change）
  - $\beta_3$：介入による傾き変化（Slope Change）
  - $I_t$：介入ダミー変数（$I_t = 1$ if $t > t_0$, else $0$）
  - $t_0$：介入時点

- **自己回帰構造**：
  - $\rho$（`y_rho`）：観測値 $y_t$ の1期前ラグの係数（$0 \leq \rho < 1$）
  - 観測値自体に動学的な依存関係を導入

- **誤差項** $\varepsilon_t$：
  $$
  \varepsilon_t = \phi \varepsilon_{t-1} + u_t, \quad u_t \sim N(0, \sigma^2(1-\phi^2))
  $$
  - $\phi$（`ar_coef`）：誤差項のAR(1)係数（$0 \leq \phi < 1$）
  - $u_t$：独立な正規ホワイトノイズ
  - 分散 $\sigma^2(1-\phi^2)$ により定常性を保証

### 1.2 モデルの特徴

このモデルは以下の特性を持つ：

1. **観測値レベルのAR構造**（$\rho \neq 0$）：
   - $y_t$ が直接 $y_{t-1}$ に依存する
   - 経済変数（売上、株価など）や生物学的データ（個体数、濃度など）でよく見られる構造
   - **内生性の源泉**：介入ダミー $I_t$ が $y_{t-1}$ を通じて $y_t$ に影響

2. **誤差項のAR構造**（$\phi \neq 0$）：
   - 観測誤差や測定誤差の時間相関を表現
   - OLS推定量の標準誤差に影響（点推定値自体は一致性を保つ）

3. **介入効果の動学**：
   - **即時効果（短期効果）**：$\beta_2 \cdot (1-\rho)$
   - **長期均衡効果**：$\beta_2$
   - AR構造により、介入の影響が複数期にわたって波及

---

## 2. $(1-\rho)$ スケーリングの背景

### 2.1 理論的背景：AR(1)過程の定常状態

モデルを変形すると：

$$
y_t - \rho y_{t-1} = \mu_t \cdot (1-\rho) + \varepsilon_t
$$

両辺の期待値をとり、定常状態（$E[y_t] = E[y_{t-1}]$）を仮定すると：

$$
E[y_t](1-\rho) = E[\mu_t](1-\rho)
$$

$$
\therefore E[y_t] = E[\mu_t]
$$

つまり、**定常状態では $y_t$ の期待値は決定論的成分 $\mu_t$ の期待値と等しくなる**。

しかし、データ生成時に $\mu_t$ をそのまま使うと、AR(1)の増幅効果により定常状態での平均値が $\frac{E[\mu_t]}{1-\rho}$ に膨れ上がる。これを防ぐため、データ生成時に決定論的成分を $(1-\rho)$ でスケーリングしている。

### 2.2 実務的意義

#### 2.2.1 非定常な実データへの適用

実務において扱う時系列データ（売上、気温、患者数など）の多くは以下の特性を持つ：

- **トレンドや季節性**：決定論的成分 $\mu_t$ が時間変化する
- **慣性（inertia）**：過去の値に引きずられる性質（$\rho > 0$）
- **外生的ショック**：介入や政策変更の効果

このようなデータに対して、$(1-\rho)$ スケーリングを用いることで：

1. **ベースラインの維持**：
   - 介入前のベースライン水準 $\beta_0$ が実際のデータの平均値と一致
   - 解釈が直感的になる

2. **介入効果の測定**：
   - AR構造を考慮しない単純な前後比較（OLS）は**過大推定**される
   - 適切なモデル（ARIMA、IV）は**即時効果** $\beta_2 \cdot (1-\rho)$ を推定
   - 長期効果は累積的に $\beta_2$ に収束

3. **データの安定性**：
   - $(1-\rho)$ スケーリングにより、シミュレーション時の爆発的な増加を防止
   - バーンイン期間からのスムーズな移行

#### 2.2.2 実例：マーケティング施策の効果測定

あるオンライン広告キャンペーンの効果を測定する場合：

- **観測変数** $y_t$：日次売上
- **介入** $I_t$：広告配信開始（$t_0$ 時点）
- **AR構造**：前日の売上が当日に影響（顧客のリピート購入）

このとき、

- **OLS推定**：広告配信開始直後の売上増加を捉えるが、前日の売上の影響を無視 → **過大推定**
- **ARIMA/IV推定**：前日の売上の影響を除去した**純粋な広告効果**（即時効果）を推定
- **長期効果**：広告効果が累積して定常状態に達した後の平均的な売上増加

$(1-\rho)$ スケーリングされた真の値と比較することで、推定量の不偏性・一致性を適切に評価できる。

---

## 3. モデル定式化の考え方

### 3.1 推定モデルの種類

データ生成過程に対して、以下の推定方法を比較する：

#### 3.1.1 OLS（ラグ項なし）

$$
y_t = \alpha_0 + \alpha_1 t + \alpha_2 I_t + \alpha_3 (t-t_0)I_t + e_t
$$

- **特徴**：
  - AR構造を無視
  - 残差に系列相関が残る
  - $\alpha_2$ は $\beta_2$ の**過大推定**（バイアスあり）

- **推定対象**：
  - 明確な理論値は定義できない（バイアスのため）
  - 実務では「総合的な効果」として解釈されることがあるが、理論的根拠は薄い

#### 3.1.2 OLS（ラグ項付き）

$$
y_t = \alpha_0 + \alpha_1 t + \alpha_2 I_t + \alpha_3 (t-t_0)I_t + \gamma y_{t-1} + e_t
$$

- **特徴**：
  - $y_{t-1}$ を説明変数に追加
  - **内生性バイアス**：$I_t$ と $y_{t-1}$ が相関（$y_{t-1}$ が過去の介入の影響を含む）
  - $\gamma$ は $\rho$ を一致推定できない

- **推定対象**：
  - $\alpha_2 \approx \beta_2 \cdot (1-\rho)$（バイアスあり）
  - $\gamma > \rho$（過大推定される傾向）

#### 3.1.3 ARIMA（外生変数付き）

$$
y_t = \alpha_0 + \alpha_1 t + \alpha_2 I_t + \alpha_3 (t-t_0)I_t + \eta_t
$$
$$
\eta_t = \theta_1 \eta_{t-1} + \epsilon_t + \psi_1 \epsilon_{t-1}
$$

- **特徴**：
  - 誤差項のAR・MA構造を直接モデル化
  - 最尤法により一致推定量を得る
  - 内生性の問題を完全には解決できない（$y_t$ レベルのAR構造には対処が不十分）

- **推定対象**：
  - $\alpha_2 \xrightarrow{p} \beta_2 \cdot (1-\rho)$（一致推定量、ただし小標本では若干のバイアス）

#### 3.1.4 操作変数法（2SLS-IV）

$$
\text{第1段階: } y_{t-1} = \pi_0 + \pi_1 t + \pi_2 I_t + \pi_3 (t-t_0)I_t + \pi_4 y_{t-2} + v_t
$$
$$
\text{第2段階: } y_t = \alpha_0 + \alpha_1 t + \alpha_2 I_t + \alpha_3 (t-t_0)I_t + \gamma \hat{y}_{t-1} + e_t
$$

- **特徴**：
  - $y_{t-2}$ を操作変数として使用し、$y_{t-1}$ の内生性を除去
  - **一致推定量**を得られる（適切な操作変数の下で）

- **推定対象**：
  - $\alpha_2 \xrightarrow{p} \beta_2 \cdot (1-\rho)$（一致推定量）
  - $\gamma \xrightarrow{p} \rho$（一致推定量）

### 3.2 $y_\rho$（`y_rho`）と $y_{t-1}$ の関係

#### データ生成過程（DGP）における $\rho$：

$$
y_t = \mu_t \cdot (1-\rho) + \rho \cdot y_{t-1} + \varepsilon_t
$$

ここで、$\rho$ は**構造パラメータ**であり、観測値 $y_t$ がどの程度前期の値 $y_{t-1}$ に依存するかを表す。

#### 推定モデルにおける $\gamma$（$y_{t-1}$ の係数）：

- **OLS（ラグ項付き）**：
  $$
  \hat{\gamma}_{\text{OLS}} > \rho
  $$
  内生性により過大推定される。$I_t$ が $y_{t-1}$ と相関するため。

- **IV（2SLS）**：
  $$
  \hat{\gamma}_{\text{IV}} \xrightarrow{p} \rho
  $$
  操作変数 $y_{t-2}$ により内生性を除去し、真の $\rho$ を一致推定。

#### 介入効果の推定値：

- **OLS（ラグなし）**：
  $$
  \hat{\alpha}_2^{\text{OLS}} \approx \beta_2 + \text{bias}
  $$

- **OLS（ラグ付き）、ARIMA、IV**：
  $$
  \hat{\alpha}_2 \xrightarrow{p} \beta_2 \cdot (1-\rho)
  $$

### 3.3 真の値の定義とモンテカルロシミュレーション

モンテカルロシミュレーションで各推定方法の性能を評価する際、**推定対象に応じた真の値**を設定する必要がある：

| パラメータ | DGPでの定義 | 推定モデルの真の値（ラグ項付き） |
|-----------|------------|--------------------------------|
| Baseline ($\beta_0$) | `baseline` | `baseline × (1 - y_rho)` |
| Trend ($\beta_1$) | `trend` | `trend × (1 - y_rho)` |
| Level Change ($\beta_2$) | `level_change` | `level_change × (1 - y_rho)` |
| Slope Change ($\beta_3$) | `slope_change` | `slope_change × (1 - y_rho)` |

これにより、

- **OLS（ラグ項付き）**：若干のバイアスを持ちつつも真の値に近づく
- **ARIMA**：ほぼ真の値に収束
- **IV**：真の値に一致収束（最も優れた性能）

一方、**OLS（ラグなし）**は $(1-\rho)$ スケーリングされた真の値とは異なる値を推定するため、明確なバイアスが可視化される。

---

## 4. まとめ

### 4.1 データ生成過程の設計意図

1. **現実的なデータ構造の模倣**：
   - 観測値レベルのAR構造（$\rho$）と誤差項のAR構造（$\phi$）の両方を導入
   - 介入効果の動学的な波及を表現

2. **推定方法の性能評価**：
   - OLS、ARIMA、IVの一致性・不偏性を比較
   - 内生性バイアスの影響を定量化

3. **実務への示唆**：
   - AR構造を無視したOLSの危険性を示す
   - 適切な推定方法（ARIMA、IV）の重要性を強調

### 4.2 $(1-\rho)$ スケーリングの意義

- **理論的側面**：AR(1)過程の定常状態を保ち、シミュレーションの安定性を確保
- **実務的側面**：実データにおける介入効果の即時効果と長期効果の区別を明確化
- **教育的側面**：AR構造が推定値に与える影響を視覚的に理解しやすくする

### 4.3 今後の展開

- **より複雑なAR構造**：AR(p)、ARMA(p,q) への拡張
- **非線形モデル**：閾値効果、構造変化の考慮
- **実データへの適用**：本シミュレーション結果を基にした実証研究
